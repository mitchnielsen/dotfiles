#!/usr/bin/env bash

# git worktree remove: changes back to the
# default branch directory and removes the PR
# branch directory.
#
# Because we use 'cd' in this script, it needs to be
# sourced instead of called directly:
#
#  source ~/bin/git-worktree-remove
#
# Set this as an alias for easy usage.

branch_name=$(git symbolic-ref --short HEAD)
worktree_name=$(basename "${PWD}")
default_branch_name=$(git default-branch)

# Abort if Terraform state directory exists
if [ -d './.terraform' ]; then
  echo 'Terraform directory exists, aborting...'
  exit 1
fi

# Try to determine the parent branch from reflog
# Look for the most recent branch checkout before entering this worktree
parent_branch=$(git reflog show HEAD --format="%gs" | \
  grep -E "checkout: moving from .* to ${branch_name}" | \
  head -1 | \
  sed -E "s/checkout: moving from (.*) to ${branch_name}/\1/")

# Fall back to default branch if we can't determine parent
if [ -z "${parent_branch}" ]; then
  parent_branch="${default_branch_name}"
fi

cd ../"${parent_branch}" || exit
git worktree remove "${worktree_name}"
git branch -D "${branch_name}"
