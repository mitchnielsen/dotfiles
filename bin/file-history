#!/usr/bin/env bash

# Select a file using fzf
file=$(git ls-files | fzf --prompt="Select file: " --preview="bat --color=always --style=numbers {}" --preview-window=right:60%)

# Exit if no file was selected
if [[ -z "$file" ]]; then
  exit 0
fi

# Get git history for the selected file and display with fzf
commit=$(git log --oneline --follow -- "$file" \
  | fzf --prompt="Select commit for $file: " \
        --preview="git show --color=always {1} -- $file" \
        --preview-window=right:60%:wrap \
  | awk '{print $1}')

# Output the selected commit hash and GitHub URL
if [[ -n "$commit" ]]; then
  # Get the remote URL and extract owner/repo
  remote_url=$(git config --get remote.origin.url)

  # Handle both SSH and HTTPS URLs
  if [[ "$remote_url" =~ github\.com[:/](.+/[^.]+)(\.git)?$ ]]; then
    repo_path="${BASH_REMATCH[1]}"
    github_url="https://github.com/${repo_path}/commit/${commit}"
    echo "$github_url"
  else
    echo "$commit"
  fi
fi
